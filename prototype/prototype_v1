import React, { useState, useEffect } from 'react';
import {
  Search,
  BarChart2,
  Users,
  FileText,
  Database,
  Bell,
  Settings,
  ChevronRight,
  Download,
  MessageSquare,
  LayoutDashboard,
  PieChart,
  Clock,
  CheckCircle,
  AlertTriangle,
  Sparkles,
  ArrowRight
} from 'lucide-react';

// --- Mock Data & Components ---

const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-xl border border-slate-200 shadow-sm ${className}`}>
    {children}
  </div>
);

const Badge = ({ children, type = "neutral" }) => {
  const styles = {
    neutral: "bg-slate-100 text-slate-600",
    success: "bg-emerald-100 text-emerald-700",
    warning: "bg-amber-100 text-amber-700",
    primary: "bg-blue-100 text-blue-700",
    purple: "bg-purple-100 text-purple-700",
  };
  return (
    <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium ${styles[type] || styles.neutral}`}>
      {children}
    </span>
  );
};

export default function HRaiApp() {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [searchQuery, setSearchQuery] = useState('');
  const [isSearching, setIsSearching] = useState(false);
  const [showResult, setShowResult] = useState(false);
  const [loadingStep, setLoadingStep] = useState(0);

  // Giả lập quy trình AI suy nghĩ
  const handleSearch = (query) => {
    setSearchQuery(query);
    setIsSearching(true);
    setShowResult(false);
    setLoadingStep(0);

    // Simulation steps
    setTimeout(() => setLoadingStep(1), 800); // Hiểu ý định
    setTimeout(() => setLoadingStep(2), 1600); // Viết SQL
    setTimeout(() => setLoadingStep(3), 2400); // Truy xuất DB
    setTimeout(() => {
      setIsSearching(false);
      setShowResult(true);
    }, 3200);
  };

  const SuggestionChip = ({ text }) => (
    <button
      onClick={() => handleSearch(text)}
      className="flex items-center gap-2 px-4 py-2 bg-slate-50 hover:bg-blue-50 text-slate-600 hover:text-blue-600 border border-slate-200 hover:border-blue-200 rounded-full text-sm transition-all"
    >
      <Sparkles size={14} className="text-purple-500" />
      {text}
    </button>
  );

  return (
    <div className="flex h-screen bg-slate-50 font-sans text-slate-800 overflow-hidden">
      {/* Sidebar */}
      <aside className="w-64 bg-slate-900 text-slate-300 flex flex-col hidden md:flex">
        <div className="p-6 flex items-center gap-3">
          <div className="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-bold text-lg">
            H
          </div>
          <span className="text-white font-bold text-xl tracking-tight">HR<span className="font-light text-blue-400">.ai</span></span>
        </div>

        <nav className="flex-1 px-4 space-y-2 mt-4">
          <div className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 px-2">Menu chính</div>
          <NavItem icon={<LayoutDashboard size={20} />} label="Tổng quan" active={activeTab === 'dashboard'} onClick={() => { setActiveTab('dashboard'); setShowResult(false); }} />
          <NavItem icon={<Clock size={20} />} label="Chấm công (Work Logs)" />
          <NavItem icon={<Users size={20} />} label="Nhân sự" />
          <NavItem icon={<BarChart2 size={20} />} label="Báo cáo" />

          <div className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 mt-8 px-2">Data Pipeline</div>
          <NavItem icon={<FileText size={20} />} label="Import CSV" />
          <NavItem icon={<Database size={20} />} label="API Integration" />
        </nav>

        <div className="p-4 border-t border-slate-800">
          <div className="flex items-center gap-3">
            <div className="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white text-xs font-bold">QA</div>
            <div className="flex-1 min-w-0">
              <p className="text-sm font-medium text-white truncate">Quốc Anh</p>
              <p className="text-xs text-slate-500 truncate">HR Manager</p>
            </div>
            <Settings size={16} className="text-slate-500 cursor-pointer hover:text-white" />
          </div>
        </div>
      </aside>

      {/* Main Content */}
      <main className="flex-1 flex flex-col min-w-0 overflow-hidden">
        {/* Header */}
        <header className="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 z-10">
          <h1 className="text-lg font-semibold text-slate-800 flex items-center gap-2">
            {showResult ? (
              <>
                <span className="text-slate-400 cursor-pointer hover:text-blue-600" onClick={() => setShowResult(false)}>Tổng quan</span>
                <ChevronRight size={16} className="text-slate-400" />
                <span>Kết quả phân tích AI</span>
              </>
            ) : "Dashboard quản trị"}
          </h1>
          <div className="flex items-center gap-4">
            <button className="relative p-2 text-slate-500 hover:bg-slate-100 rounded-full">
              <Bell size={20} />
              <span className="absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full border-2 border-white"></span>
            </button>
            <div className="h-8 w-px bg-slate-200"></div>
            <button className="text-sm text-blue-600 font-medium">Trợ giúp</button>
          </div>
        </header>

        {/* Scrollable Content */}
        <div className="flex-1 overflow-y-auto p-6 md:p-8">

          {/* SEARCH SECTION (HERO) */}
          <div className="max-w-4xl mx-auto mb-10">
            <div className="relative group z-20">
              <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <Sparkles className={`w-5 h-5 ${isSearching ? 'text-blue-500 animate-pulse' : 'text-slate-400'}`} />
              </div>
              <input
                type="text"
                className="block w-full pl-12 pr-20 py-4 bg-white border-2 border-slate-200 rounded-2xl text-slate-900 placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 shadow-sm transition-all text-lg"
                placeholder="Hỏi HR.ai về dữ liệu nhân sự, công, lương..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleSearch(searchQuery)}
              />
              <div className="absolute inset-y-0 right-2 flex items-center">
                <button
                  onClick={() => handleSearch(searchQuery)}
                  className="p-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors shadow-md"
                >
                  <ArrowRight size={20} />
                </button>
              </div>
            </div>

            {/* Suggestions */}
            {!isSearching && !showResult && (
              <div className="mt-4 flex flex-wrap gap-2 justify-center">
                <SuggestionChip text="Tổng giờ làm của team Tech tháng này?" />
                <SuggestionChip text="So sánh hiệu suất NV Chính thức vs Thời vụ" />
                <SuggestionChip text="Ai có số giờ làm dưới 40h?" />
                <SuggestionChip text="Dữ liệu từ API có ổn định không?" />
              </div>
            )}

            {/* Loading State */}
            {isSearching && (
              <div className="mt-6 bg-white p-6 rounded-xl border border-blue-100 shadow-sm">
                <div className="space-y-4">
                  <LoadingStep step={1} current={loadingStep} text="Phân tích ngữ nghĩa câu hỏi..." />
                  <LoadingStep step={2} current={loadingStep} text="Tạo câu truy vấn SQL (Query Generation)..." />
                  <LoadingStep step={3} current={loadingStep} text="Tổng hợp dữ liệu từ 3 nguồn (Manual, CSV, API)..." />
                </div>
              </div>
            )}
          </div>

          {/* MAIN VIEW: Dashboard or Result */}
          {showResult ? (
            <AIResultView query={searchQuery} />
          ) : (
            <DashboardOverview />
          )}

        </div>
      </main>
    </div>
  );
}

// --- Sub Components ---

const NavItem = ({ icon, label, active, onClick }) => (
  <button
    onClick={onClick}
    className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors text-sm font-medium ${active
        ? 'bg-blue-600 text-white'
        : 'text-slate-400 hover:bg-slate-800 hover:text-white'
      }`}
  >
    {icon}
    <span>{label}</span>
  </button>
);

const LoadingStep = ({ step, current, text }) => {
  let status = 'waiting'; // waiting, active, done
  if (current === step) status = 'active';
  if (current > step) status = 'done';

  return (
    <div className="flex items-center gap-3">
      <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs border-2 transition-all ${status === 'done' ? 'bg-green-500 border-green-500 text-white' :
          status === 'active' ? 'border-blue-500 text-blue-500 animate-spin-slow' : 'border-slate-200 text-slate-300'
        }`}>
        {status === 'done' ? <CheckCircle size={14} /> : step}
      </div>
      <span className={`${status === 'active' ? 'text-blue-600 font-medium' : status === 'done' ? 'text-slate-500 line-through' : 'text-slate-400'}`}>
        {text}
      </span>
    </div>
  );
};

const DashboardOverview = () => (
  <div className="animate-fade-in-up">
    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <StatCard
        title="Tổng nhân sự"
        value="248"
        trend="+12% tháng này"
        trendUp={true}
        icon={<Users className="text-blue-600" />}
        color="blue"
      />
      <StatCard
        title="Tổng giờ công (Tháng 12)"
        value="14,205 h"
        trend="-5% so với tháng trước"
        trendUp={false}
        icon={<Clock className="text-purple-600" />}
        color="purple"
      />
      <StatCard
        title="Chờ duyệt (Pending)"
        value="18"
        sub="Cần xử lý ngay"
        icon={<AlertTriangle className="text-amber-600" />}
        color="amber"
      />
    </div>

    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <Card className="p-6">
        <h3 className="font-semibold text-slate-800 mb-4 flex items-center gap-2">
          <Database size={18} className="text-slate-400" />
          Trạng thái Data Pipeline
        </h3>
        <div className="space-y-4">
          <PipelineItem source="Nhập tay (Manual)" status="active" time="Vừa xong" count="45 records" />
          <PipelineItem source="Import CSV (Batch)" status="active" time="2 giờ trước" count="120 records" />
          <PipelineItem source="API (Chi nhánh JP)" status="warning" time="Hôm qua" count="0 records" />
        </div>
      </Card>

      <Card className="p-6">
        <h3 className="font-semibold text-slate-800 mb-4">Phân bổ nhân sự</h3>
        {/* Simple CSS Chart Mock */}
        <div className="space-y-4">
          <div className="space-y-1">
            <div className="flex justify-between text-sm text-slate-600">
              <span>Chính thức (Full-time)</span>
              <span>65%</span>
            </div>
            <div className="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
              <div className="h-full bg-blue-500 w-[65%] rounded-full"></div>
            </div>
          </div>
          <div className="space-y-1">
            <div className="flex justify-between text-sm text-slate-600">
              <span>Thời vụ (Seasonal)</span>
              <span>25%</span>
            </div>
            <div className="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
              <div className="h-full bg-emerald-500 w-[25%] rounded-full"></div>
            </div>
          </div>
          <div className="space-y-1">
            <div className="flex justify-between text-sm text-slate-600">
              <span>Nước ngoài (Expat)</span>
              <span>10%</span>
            </div>
            <div className="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
              <div className="h-full bg-purple-500 w-[10%] rounded-full"></div>
            </div>
          </div>
        </div>
      </Card>
    </div>
  </div>
);

const AIResultView = ({ query }) => (
  <div className="animate-fade-in-up space-y-6">
    {/* AI Insight Header */}
    <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 p-6 rounded-xl flex items-start gap-4">
      <div className="p-2 bg-white rounded-lg shadow-sm">
        <Sparkles className="text-blue-600 w-6 h-6" />
      </div>
      <div>
        <h3 className="font-bold text-slate-800 text-lg mb-1">Kết quả phân tích</h3>
        <p className="text-slate-600 leading-relaxed">
          Tôi đã tổng hợp dữ liệu từ <strong>1/12/2024</strong> đến nay.
          <br />
          Dữ liệu cho thấy <span className="font-semibold text-emerald-700">Nhân viên Thời vụ</span> đang có xu hướng tăng ca nhiều hơn (trung bình 9.5h/ngày) so với Chính thức.
          Dưới đây là biểu đồ so sánh chi tiết theo nguồn dữ liệu.
        </p>
        <div className="mt-3 flex gap-2">
          <Badge type="primary">Data Source: All</Badge>
          <Badge type="success">Status: Approved Only</Badge>
        </div>
      </div>
    </div>

    {/* Visualization Area */}
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
      {/* Chart */}
      <Card className="lg:col-span-2 p-6 min-h-[300px] flex flex-col">
        <div className="flex justify-between items-center mb-6">
          <h4 className="font-semibold text-slate-700">Biểu đồ so sánh tổng giờ làm</h4>
          <button className="text-slate-400 hover:text-blue-600"><Download size={18} /></button>
        </div>

        {/* CSS-only Bar Chart visualization */}
        <div className="flex-1 flex items-end gap-8 px-4 pb-4 border-b border-slate-200">
          {/* Column 1 */}
          <div className="flex-1 flex flex-col items-center gap-2 group cursor-pointer">
            <div className="text-xs font-bold text-slate-700 group-hover:text-blue-600 transition-colors">4,500h</div>
            <div className="w-full bg-blue-100 rounded-t-lg relative h-32 hover:bg-blue-200 transition-all">
              <div className="absolute bottom-0 left-0 right-0 bg-blue-500 h-[80%] rounded-t-lg group-hover:bg-blue-600"></div>
            </div>
            <div className="text-sm text-slate-500 font-medium">Chính thức</div>
          </div>

          {/* Column 2 */}
          <div className="flex-1 flex flex-col items-center gap-2 group cursor-pointer">
            <div className="text-xs font-bold text-slate-700 group-hover:text-emerald-600 transition-colors">3,200h</div>
            <div className="w-full bg-emerald-100 rounded-t-lg relative h-48 hover:bg-emerald-200 transition-all">
              <div className="absolute bottom-0 left-0 right-0 bg-emerald-500 h-[100%] rounded-t-lg group-hover:bg-emerald-600"></div>
            </div>
            <div className="text-sm text-slate-500 font-medium">Thời vụ</div>
          </div>

          {/* Column 3 */}
          <div className="flex-1 flex flex-col items-center gap-2 group cursor-pointer">
            <div className="text-xs font-bold text-slate-700 group-hover:text-purple-600 transition-colors">1,200h</div>
            <div className="w-full bg-purple-100 rounded-t-lg relative h-20 hover:bg-purple-200 transition-all">
              <div className="absolute bottom-0 left-0 right-0 bg-purple-500 h-[30%] rounded-t-lg group-hover:bg-purple-600"></div>
            </div>
            <div className="text-sm text-slate-500 font-medium">Expat</div>
          </div>
        </div>
        <div className="flex justify-center mt-4 gap-6">
          <div className="flex items-center gap-2 text-xs text-slate-500">
            <div className="w-3 h-3 bg-blue-500 rounded-sm"></div> Nhập tay
          </div>
          <div className="flex items-center gap-2 text-xs text-slate-500">
            <div className="w-3 h-3 bg-emerald-500 rounded-sm"></div> Import CSV
          </div>
        </div>
      </Card>

      {/* Recommended Action / Summary */}
      <div className="space-y-6">
        <Card className="p-5 border-l-4 border-l-blue-500">
          <h4 className="font-semibold text-slate-800 mb-2">Gợi ý hành động</h4>
          <ul className="space-y-3">
            <li className="flex gap-3 items-start text-sm text-slate-600">
              <CheckCircle size={16} className="text-blue-500 mt-0.5 shrink-0" />
              Cân nhắc tăng ngân sách OT cho nhóm Thời vụ vì đang vượt mức 20%.
            </li>
            <li className="flex gap-3 items-start text-sm text-slate-600">
              <CheckCircle size={16} className="text-blue-500 mt-0.5 shrink-0" />
              Kiểm tra lại dữ liệu import CSV ngày 12/12 do có dấu hiệu trùng lặp.
            </li>
          </ul>
          <button className="mt-4 w-full py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium hover:bg-slate-50 text-slate-700">
            Tạo báo cáo chi tiết
          </button>
        </Card>

        <Card className="p-5">
          <h4 className="font-semibold text-slate-800 mb-3">SQL Query được tạo ra</h4>
          <div className="bg-slate-900 rounded-lg p-3 overflow-x-auto">
            <code className="text-xs font-mono text-green-400">
              SELECT contract_type, <br />
              SUM(hours) as total <br />
              FROM work_logs <br />
              WHERE date &gt;= '2024-12-01' <br />
              AND status = 1 <br />
              GROUP BY contract_type
            </code>
          </div>
        </Card>
      </div>
    </div>

    {/* Detailed Table */}
    <Card className="overflow-hidden">
      <div className="px-6 py-4 border-b border-slate-200 bg-slate-50/50 flex justify-between items-center">
        <h4 className="font-semibold text-slate-700">Chi tiết dữ liệu</h4>
        <button className="text-sm text-blue-600 hover:underline">Xem tất cả</button>
      </div>
      <div className="overflow-x-auto">
        <table className="w-full text-sm text-left">
          <thead className="bg-slate-50 text-slate-500 font-medium">
            <tr>
              <th className="px-6 py-3">Nhóm nhân sự</th>
              <th className="px-6 py-3">Tổng giờ</th>
              <th className="px-6 py-3">Trung bình/ngày</th>
              <th className="px-6 py-3">Nguồn đóng góp chính</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-slate-100">
            <tr>
              <td className="px-6 py-4 font-medium text-slate-700">Chính thức</td>
              <td className="px-6 py-4">4,500</td>
              <td className="px-6 py-4">8.2h</td>
              <td className="px-6 py-4"><Badge type="neutral">Manual Input</Badge></td>
            </tr>
            <tr>
              <td className="px-6 py-4 font-medium text-slate-700">Thời vụ</td>
              <td className="px-6 py-4 text-emerald-600 font-bold">3,200</td>
              <td className="px-6 py-4">9.5h</td>
              <td className="px-6 py-4"><Badge type="purple">Import CSV</Badge></td>
            </tr>
            <tr>
              <td className="px-6 py-4 font-medium text-slate-700">Expat (Nước ngoài)</td>
              <td className="px-6 py-4">1,200</td>
              <td className="px-6 py-4">8.0h</td>
              <td className="px-6 py-4"><Badge type="warning">API Integration</Badge></td>
            </tr>
          </tbody>
        </table>
      </div>
    </Card>

  </div>
);

const StatCard = ({ title, value, trend, trendUp, icon, color, sub }) => (
  <Card className="p-6 hover:shadow-md transition-shadow">
    <div className="flex justify-between items-start mb-4">
      <div>
        <p className="text-sm font-medium text-slate-500 mb-1">{title}</p>
        <h3 className="text-2xl font-bold text-slate-800">{value}</h3>
      </div>
      <div className={`p-2 rounded-lg bg-${color}-50`}>
        {icon}
      </div>
    </div>
    <div className="flex items-center text-sm">
      {sub ? (
        <span className="text-amber-600 font-medium">{sub}</span>
      ) : (
        <span className={trendUp ? "text-emerald-600 font-medium" : "text-rose-600 font-medium"}>
          {trend}
        </span>
      )}
    </div>
  </Card>
);

const PipelineItem = ({ source, status, time, count }) => (
  <div className="flex items-center justify-between p-3 rounded-lg bg-slate-50 hover:bg-slate-100 transition-colors">
    <div className="flex items-center gap-3">
      <div className={`w-2 h-2 rounded-full ${status === 'active' ? 'bg-emerald-500' : 'bg-amber-500'}`}></div>
      <div>
        <p className="text-sm font-medium text-slate-700">{source}</p>
        <p className="text-xs text-slate-500">{time}</p>
      </div>
    </div>
    <div className="text-right">
      <Badge type={status === 'active' ? 'success' : 'warning'}>{status === 'active' ? 'Sync' : 'Delay'}</Badge>
      <p className="text-xs text-slate-400 mt-1">{count}</p>
    </div>
  </div>
);